<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Molly Harrison">

<title>How accurately can we predict market cap values for S&amp;P 500 companies using historical data?</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="Final_Exam_files/libs/clipboard/clipboard.min.js"></script>
<script src="Final_Exam_files/libs/quarto-html/quarto.js"></script>
<script src="Final_Exam_files/libs/quarto-html/popper.min.js"></script>
<script src="Final_Exam_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="Final_Exam_files/libs/quarto-html/anchor.min.js"></script>
<link href="Final_Exam_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="Final_Exam_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="Final_Exam_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="Final_Exam_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="Final_Exam_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">How accurately can we predict market cap values for S&amp;P 500 companies using historical data?</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Molly Harrison </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>One of the key metrics investors use to determine the value of a company’s equity (and therefore its stock value) is its market capitalization or <em>market cap.</em> There are many approaches and considerations to analyze when making an investment, and more and more data science methods have begun to make an appearance in investment determination. In this report we are going to look at how accurately we can predict market cap values using historical data.</p>
<p>Typically, investors use methods such as <em>discounted cash flows</em> (DCF) and other models to determine the equity value of a company. The equity value and market cap for a company are different, as market cap is the valuation of the company through the lens of financial markets (share price multiplied by outstanding shares), while equity valuation comes from its financial conditions (assets and liabilities). Investors aim to find the equity value of a company in order to make sound and profitable investment choices. Even though these two financial concepts are different, they both represent the valuation of a company’s equity and will be similar (equity value is the market cap with the additional consideration of other equity information). For our purposes, in this report, a company’s value will be referred to as one concept, and we will be predicting market cap as a proxy for how the public markets perceive equity value, acknowledging that real equity value includes additional factors.</p>
<p>Methods to calculate equity value such as discounted cash flows involve forecasting financial data and estimating growth rates. They rely on historical data as well as research and knowledge of the company so the resulting estimated equity value is a compilation of real data and the investor’s assumptions.</p>
<p>In this report we will investigate whether or not we can use supervised learning algorithms, focusing on neural networks, to predict market cap value (specifically looking at S&amp;P 500 companies, which are the 500 biggest U.S. based companies). We will examine how accurate our predictions are considering we are removing the methodical calculations and investor assumptions that lead to an accurate equity value analysis.</p>
</section>
<section id="the-data" class="level2">
<h2 class="anchored" data-anchor-id="the-data">The Data</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(caret)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(neuralnet)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readxl)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mice)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>financial_data <span class="ot">&lt;-</span> <span class="fu">read_xlsx</span>(<span class="st">"Calcbench Data Query Export.xlsx"</span>)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>financial_data[financial_data <span class="sc">==</span> <span class="dv">0</span>] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>clean_data <span class="ot">&lt;-</span> financial_data[<span class="sc">!</span><span class="fu">is.na</span>(financial_data<span class="sc">$</span><span class="st">`</span><span class="at">MarketCapAtEndOfPeriod 2023</span><span class="st">`</span>),]</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(clean_data) <span class="ot">&lt;-</span> <span class="fu">make.names</span>(<span class="fu">colnames</span>(clean_data))</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>imputed_data <span class="ot">&lt;-</span> <span class="fu">mice</span>(clean_data,</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>                         <span class="at">method =</span> <span class="st">"rf"</span>,</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>                         <span class="at">seed =</span> <span class="dv">1</span>,</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>                         <span class="at">maxit =</span> <span class="dv">5</span>)</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>imputed_data <span class="ot">&lt;-</span> <span class="fu">complete</span>(imputed_data)</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>imputed_data <span class="ot">&lt;-</span> imputed_data <span class="sc">|&gt;</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">na.omit</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The data we are using is from Calcbench’s bulk data interface (see references below) and exported into excel. It contains key financial data and market cap value (at the end of the year) for each S&amp;P 500 company from 2018 to 2023.</p>
</section>
<section id="visualizing-the-data" class="level2">
<h2 class="anchored" data-anchor-id="visualizing-the-data">Visualizing the Data</h2>
<p>Before beginning our predictions and analysis, we should first visualize the data. Below is a graph showing revenue vs.&nbsp;market cap in 2022 and is also colored by CapEx value to visualize three important variables in our data set.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>imputed_data <span class="sc">|&gt;</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> Revenue<span class="fl">.2022</span>, <span class="at">y =</span> MarketCapAtEndOfPeriod<span class="fl">.2022</span>, </span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>                 <span class="at">color =</span> CAPEXgross<span class="fl">.2022</span>)) <span class="sc">+</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Revenue in 2022"</span>, <span class="at">y =</span> <span class="st">"Market Cap at the end of 2022"</span>, <span class="at">color =</span> <span class="st">"Gross CapEx in 2022"</span>) <span class="sc">+</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Final_Exam_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>From this we can see that there are extreme outliers which may have a large effect on our supervised learning algorithms. In this context, it makes sense to remove these values from the data set before making predictions.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>imputed_data <span class="ot">&lt;-</span> imputed_data <span class="sc">|&gt;</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(MarketCapAtEndOfPeriod<span class="fl">.2023</span> <span class="sc">&lt;</span> <span class="fl">1e+12</span>) <span class="sc">|&gt;</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Revenue<span class="fl">.2023</span> <span class="sc">&lt;</span> <span class="fl">2e+11</span>) <span class="sc">|&gt;</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(MarketCapAtEndOfPeriod<span class="fl">.2022</span> <span class="sc">&lt;</span> <span class="fl">1e+12</span>) <span class="sc">|&gt;</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Revenue<span class="fl">.2022</span> <span class="sc">&lt;</span> <span class="fl">2e+11</span>) <span class="sc">|&gt;</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(MarketCapAtEndOfPeriod<span class="fl">.2021</span> <span class="sc">&lt;</span> <span class="fl">1e+12</span>) <span class="sc">|&gt;</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Revenue<span class="fl">.2021</span> <span class="sc">&lt;</span> <span class="fl">2e+11</span>) <span class="sc">|&gt;</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(MarketCapAtEndOfPeriod<span class="fl">.2020</span> <span class="sc">&lt;</span> <span class="fl">1e+12</span>) <span class="sc">|&gt;</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Revenue<span class="fl">.2020</span> <span class="sc">&lt;</span> <span class="fl">2e+11</span>)<span class="sc">|&gt;</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(MarketCapAtEndOfPeriod<span class="fl">.2019</span> <span class="sc">&lt;</span> <span class="fl">1e+12</span>) <span class="sc">|&gt;</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Revenue<span class="fl">.2019</span> <span class="sc">&lt;</span> <span class="fl">2e+11</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Also, we will need to scale our data, especially before working with neural networks.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>scaled_data <span class="ot">&lt;-</span> imputed_data</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>scaled_data[,<span class="dv">3</span><span class="sc">:</span><span class="dv">62</span>] <span class="ot">&lt;-</span> <span class="fu">scale</span>(imputed_data[,<span class="dv">3</span><span class="sc">:</span><span class="dv">62</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="neural-networks" class="level2">
<h2 class="anchored" data-anchor-id="neural-networks">Neural Networks</h2>
<p>One of the most prominent and important supervised learning algorithms in use today are neural networks. The general idea behind neural networks is to mimic how the brain processes data. The network consists of an input layer that takes in the data, hidden layers which process the data, and an output layer that provides the result (in our case this would be our market cap prediction). The connection from one layer to the next contain <em>weights</em> that affect how much that variable contributes to the next layer. At each layer, the model adds a bias value and the weight/bias applied to the data form the new layer of data to be passed on. Another important aspect for these networks is <em>backpropagation</em>. This is when the model takes the result of the first pass through the network, calculates the loss (i.e.&nbsp;how wrong the model is), and updates the weights in the hidden layers in order to reduce this loss. There are several types of neural networks, but we will be working with a simple application that does involve some backpropagation, which will be helpful for our algorithm accuracy.</p>
<p>We will start with a neural network of all of our 2022 data (predicting 2023 market cap) to visualize it in our context.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(NeuralNetTools)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>NN_model_first <span class="ot">&lt;-</span> <span class="fu">neuralnet</span>(MarketCapAtEndOfPeriod<span class="fl">.2023</span> <span class="sc">~</span> .,</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>                      <span class="at">data =</span> imputed_data[,<span class="dv">12</span><span class="sc">:</span><span class="dv">22</span>],</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>                      <span class="at">hidden =</span> <span class="fu">c</span>(<span class="dv">8</span>, <span class="dv">4</span>),</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>                      <span class="at">linear.output =</span> <span class="cn">FALSE</span>)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="fu">plotnet</span>(NN_model_first, <span class="at">x_names =</span> <span class="fu">c</span>(<span class="st">"Revenue"</span>, <span class="st">"Cost of Rev."</span>, <span class="st">"Cash"</span>, <span class="st">"D&amp;A"</span>, <span class="st">"OpEx"</span>, <span class="st">"EBIT"</span>, <span class="st">"CapEx"</span>, <span class="st">"Acc. Dep."</span>, <span class="st">"Liabilities"</span>, <span class="st">"MCap 2022"</span>), <span class="at">y_names =</span> <span class="st">"MCap 2023"</span>, <span class="at">node_labs =</span> <span class="cn">FALSE</span>, <span class="at">circle_cex =</span> <span class="dv">3</span>, <span class="at">rel_rsc =</span> <span class="dv">1</span>, <span class="at">pos_col =</span> <span class="st">"blue"</span>, <span class="at">neg_col =</span> <span class="st">"red"</span>, <span class="at">bord_col =</span> <span class="st">"black"</span>, <span class="at">circle_col =</span> <span class="st">"lightgrey"</span>, <span class="at">pad_x =</span> <span class="fl">0.6</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Final_Exam_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>This model takes in each of the ten financial data variables we have in our data set as inputs. It has two hidden layers with 8 and 4 nodes, and at each of these layers, the model learns how much of each variable to apply at each node and adjusts its values to get closer to the prediction for 2023 market cap. Lastly, it uses backpropagation to learn from its error and readjusts the weights to produce a final prediction for the market cap value.</p>
<p>Now that we have built a neural network and discussed how they work, we can look at actually predicting market cap data and optimizing our algorithm.</p>
<p>First we need to split our data set in half to create a training data set and testing data set so that we can determine our model’s accuracy.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>training_rows <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(scaled_data), </span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>                        <span class="at">size =</span> <span class="fu">nrow</span>(scaled_data)<span class="sc">/</span><span class="dv">2</span>)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>train_data <span class="ot">&lt;-</span> scaled_data[training_rows, ]</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>test_data <span class="ot">&lt;-</span> scaled_data[<span class="sc">-</span>training_rows, ]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We will start by only using data from 2022 to predict market cap at the end of 2023.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>NN_model <span class="ot">&lt;-</span> <span class="fu">neuralnet</span>(MarketCapAtEndOfPeriod<span class="fl">.2023</span> <span class="sc">~</span> .,</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>                      <span class="at">data =</span> train_data[,<span class="dv">12</span><span class="sc">:</span><span class="dv">22</span>],</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>                      <span class="at">hidden =</span> <span class="fu">c</span>(<span class="dv">8</span>, <span class="dv">4</span>),</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>                      <span class="at">linear.output =</span> <span class="cn">TRUE</span>)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>predictions_scaled <span class="ot">&lt;-</span> <span class="fu">predict</span>(NN_model, test_data[,<span class="dv">12</span><span class="sc">:</span><span class="dv">22</span>])</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>results_scaled <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">realMC =</span> (test_data<span class="sc">$</span>MarketCapAtEndOfPeriod<span class="fl">.2023</span>), </span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>                      <span class="at">predictedMC =</span> predictions_scaled) <span class="sc">|&gt;</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">difference =</span> <span class="fu">abs</span>(realMC <span class="sc">-</span> predictedMC),</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>         <span class="at">diff =</span> realMC <span class="sc">-</span> predictedMC)</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(results_scaled<span class="sc">$</span>difference)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.3120658</code></pre>
</div>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>predictions <span class="ot">&lt;-</span> <span class="fu">abs</span>(predictions_scaled <span class="sc">*</span> <span class="dv">88643586708</span> <span class="sc">+</span> <span class="dv">61827403017</span>)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">realMC =</span> (test_data<span class="sc">$</span>MarketCapAtEndOfPeriod<span class="fl">.2023</span><span class="sc">*</span> <span class="dv">88643586708</span> <span class="sc">+</span> <span class="dv">61827403017</span>), </span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>                      <span class="at">predictedMC =</span> predictions) <span class="sc">|&gt;</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">difference =</span> <span class="fu">abs</span>(realMC <span class="sc">-</span> predictedMC),</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">diff =</span> realMC <span class="sc">-</span> predictedMC)</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(results<span class="sc">$</span>difference)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 27662628056</code></pre>
</div>
</div>
<p>We have two values here: our scaled prediction and the unscaled value of this prediction so that we can evaluate it in context. With a mean difference of about $27.7 billion dollars, this algorithm is fairly accurate given our context. It is important to note that since some of our data reaches into the trillions, the residual produced by this prediction vs.&nbsp;actual value may be good for this data value, but when we take the average of all residuals, it has a large impact. In order to visualize how accurate our algorithm is, we can plot our residuals:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>results <span class="sc">|&gt;</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> realMC, <span class="at">y =</span> diff)) <span class="sc">+</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Real Market Cap in 2023"</span>, <span class="at">y =</span> <span class="st">"Residual"</span>) <span class="sc">+</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Final_Exam_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Looking at this, we can see that the majority of our market cap predictions are accurate, as most of the residuals are in a large cluster near the <code>y (residual) = 0</code> line. The farther we move away from this cluster on the x-axis, the larger the residuals become. This trend is going to have a large impact on our mean difference accuracy metric, so it is important to take that into account when analyzing this model.</p>
<p>We can also graph our real market cap vs.&nbsp;our predicted market cap and “zoom in” to get another look at how our model is performing:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>results <span class="sc">|&gt;</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> realMC, <span class="at">y =</span> predictedMC)) <span class="sc">+</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlim</span>(<span class="dv">0</span>, <span class="fl">1e+11</span>) <span class="sc">+</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylim</span>(<span class="dv">0</span>, <span class="fl">1e+11</span>) <span class="sc">+</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Real Market Cap in 2023"</span>, <span class="at">y =</span> <span class="st">"Predicted Market Cap in 2023"</span>) <span class="sc">+</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Final_Exam_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>In context, if an investor were to be using this model to predict market cap in 2023, they should analyze the outliers and not make any decision based on the predictions for those companies without looking into the company data/information to see why the difference was so extreme (i.e.&nbsp;was there something that happened this year that led to this outcome that may not be the case for other years?).</p>
<p>This last model only looked at 2022 data to predict 2023 market cap. Let’s repeat the same steps to create a model using all historical data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>NN_model_large <span class="ot">&lt;-</span> <span class="fu">neuralnet</span>(MarketCapAtEndOfPeriod<span class="fl">.2023</span> <span class="sc">~</span> .,</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>                      <span class="at">data =</span> train_data[,<span class="dv">12</span><span class="sc">:</span><span class="dv">62</span>],</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>                      <span class="at">hidden =</span> <span class="fu">c</span>(<span class="dv">40</span>, <span class="dv">20</span>, <span class="dv">10</span>),</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>                      <span class="at">linear.output =</span> <span class="cn">TRUE</span>)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>predictions_scaled2 <span class="ot">&lt;-</span> <span class="fu">compute</span>(NN_model_large, test_data[,<span class="dv">12</span><span class="sc">:</span><span class="dv">62</span>])</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>predictions_scaled2 <span class="ot">&lt;-</span> predictions_scaled2<span class="sc">$</span>net.result</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>results_scaled2 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">realMC =</span> (test_data<span class="sc">$</span>MarketCapAtEndOfPeriod<span class="fl">.2023</span>), </span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>                      <span class="at">predictedMC =</span> predictions_scaled2) <span class="sc">|&gt;</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">difference =</span> <span class="fu">abs</span>(realMC <span class="sc">-</span> predictedMC))</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(results_scaled2<span class="sc">$</span>difference)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.3290123</code></pre>
</div>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>predictions2 <span class="ot">&lt;-</span> <span class="fu">abs</span>(predictions_scaled2 <span class="sc">*</span> <span class="dv">88643586708</span> <span class="sc">+</span> <span class="dv">61827403017</span>)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>results2 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">realMC =</span> (test_data<span class="sc">$</span>MarketCapAtEndOfPeriod<span class="fl">.2023</span><span class="sc">*</span> <span class="dv">88643586708</span> <span class="sc">+</span> <span class="dv">61827403017</span>), </span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>                      <span class="at">predictedMC =</span> predictions2) <span class="sc">|&gt;</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">difference =</span> <span class="fu">abs</span>(realMC <span class="sc">-</span> predictedMC),</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">diff =</span> realMC <span class="sc">-</span> predictedMC)</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(results2<span class="sc">$</span>difference)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 29151639149</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>results2 <span class="sc">|&gt;</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> realMC, <span class="at">y =</span> diff)) <span class="sc">+</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Real Market Cap in 2023"</span>, <span class="at">y =</span> <span class="st">"Residual"</span>) <span class="sc">+</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Final_Exam_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>This model using all data is actually less accurate than our previous model using only 2022 data. This makes sense because the most important data for predicting the next year’s finances are usually those of the current year (i.e.&nbsp;2022 for 2023), and data from prior years are used mainly to find growth rates, which we are not considering in our model.</p>
<p>Overall, because this is a simple neural network with only a few hidden layers and minimal backpropogation, it is only somewhat accurate. With a more advanced network algorithm and additional hidden layers, we could improve and optimize this model for real-world application.</p>
</section>
<section id="other-supervised-learning-algorithms" class="level2">
<h2 class="anchored" data-anchor-id="other-supervised-learning-algorithms">Other Supervised Learning Algorithms</h2>
<p>Neural networks are an extremely useful and effective algorithm for making predictions, but it is also useful to look at other algorithm types as well. Other algorithms could end up being a better fit depending on the data set and even if they are not, their features can give us insight to how we can better approach our analysis or neural network algorithm optimization.</p>
<p>Let’s look at how k-nearest neighbors would predict our data. This algorithm finds the k points that have the closest distance to our input data value and takes the average of their outcome variable. In other words, it would find the k neighbors with the closest revenue, cost of revenue, cash, etc. (all of our inputs), and take the mean of their market caps in 2023.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>knn_model <span class="ot">&lt;-</span> <span class="fu">train</span>(MarketCapAtEndOfPeriod<span class="fl">.2023</span> <span class="sc">~</span> .,</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>                  <span class="at">data =</span> train_data[,<span class="dv">12</span><span class="sc">:</span><span class="dv">62</span>],</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>                  <span class="at">method =</span> <span class="st">"knn"</span>)</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>knn_model<span class="sc">$</span>results</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Looking at mean absolute error (MAE, the same accuracy metric we used above), and comparing it to the scaled MAE for our neural network, this algorithm is actually performing better on the data, with the lowest MAE at 0.2325 for k = 7.</p>
<p>We can also use a random forest to predict market cap. A random forest is a collection of trees (decision trees that make predictions based on our variables) that are built on random samples of our data, where each tree has a limited number of variables it can make decisions based on. A random forest is a allows us to explore the data in different ways while also preventing overfitting.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>rf_model <span class="ot">&lt;-</span> <span class="fu">train</span>(MarketCapAtEndOfPeriod<span class="fl">.2023</span> <span class="sc">~</span> .,</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>                  <span class="at">data =</span> train_data[,<span class="dv">12</span><span class="sc">:</span><span class="dv">62</span>],</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>                  <span class="at">method =</span> <span class="st">"ranger"</span>,</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>                  <span class="at">importance =</span> <span class="st">"impurity"</span>)</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>rf_model<span class="sc">$</span>results</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This is the lowest MAE across all of our algorithms with 0.1459 for 50 variables. This means that our random forest is the most accurate when we give it more variables to choose from at each tree, which was the opposite outcome of our neural network analysis.</p>
<p>Random forests also allow us to look at what variables were the most important when making splits in our decision trees.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(caret)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="fu">varImp</span>(rf_model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>ranger variable importance

  only 20 most important variables shown (out of 50)

                               Overall
MarketCapAtEndOfPeriod.2022   100.0000
MarketCapAtEndOfPeriod.2021    71.2962
MarketCapAtEndOfPeriod.2020    64.8200
MarketCapAtEndOfPeriod.2019    50.2265
MarketCapAtEndOfPeriod.2018    42.3132
EBIT.2019                       3.7126
Cash.2018                       3.7084
EBIT.2021                       2.9962
Cash.2021                       2.5728
Cash.2019                       1.8749
EBIT.2022                       1.8209
EBIT.2020                       1.7011
EBIT.2018                       1.5385
Revenue.2022                    0.8537
Cash.2022                       0.8240
DepreciationAmortization.2022   0.8201
Cash.2020                       0.7667
DepreciationAmortization.2020   0.6701
OperatingExpenses.2018          0.6537
DepreciationAmortization.2018   0.6000</code></pre>
</div>
</div>
</section>
<section id="related-data" class="level2">
<h2 class="anchored" data-anchor-id="related-data">Related Data</h2>
<p>Earlier, we found that our neural network was working best when it was only using 2022 data to predict 2023 market cap. Now, we are going to look at a slightly altered data set that can help us explore this relationship further.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>new_financial_data <span class="ot">&lt;-</span> <span class="fu">read_xlsx</span>(<span class="st">"Calcbench Data Query Export 2.xlsx"</span>)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>new_financial_data[new_financial_data <span class="sc">==</span> <span class="dv">0</span>] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>new_clean_data <span class="ot">&lt;-</span> new_financial_data[<span class="sc">!</span><span class="fu">is.na</span>(new_financial_data<span class="sc">$</span><span class="st">`</span><span class="at">MarketCap NextYear</span><span class="st">`</span>),]</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(new_clean_data) <span class="ot">&lt;-</span> <span class="fu">make.names</span>(<span class="fu">colnames</span>(new_clean_data))</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>new_imputed_data <span class="ot">&lt;-</span> <span class="fu">mice</span>(new_clean_data,</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>                         <span class="at">method =</span> <span class="st">"rf"</span>,</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>                         <span class="at">seed =</span> <span class="dv">1</span>,</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>                         <span class="at">maxit =</span> <span class="dv">5</span>)</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>new_imputed_data <span class="ot">&lt;-</span> <span class="fu">complete</span>(new_imputed_data)</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>new_imputed_data <span class="ot">&lt;-</span> new_imputed_data <span class="sc">|&gt;</span></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">na.omit</span>()</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>new_imputed_data <span class="ot">&lt;-</span> new_imputed_data <span class="sc">|&gt;</span></span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(MarketCap.NextYear <span class="sc">&lt;</span> <span class="fl">2e+12</span>) <span class="sc">|&gt;</span></span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Cash.PrevYear <span class="sc">&lt;</span> <span class="fl">5.0e+10</span>)</span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>new_scaled_data <span class="ot">&lt;-</span> new_imputed_data</span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>new_scaled_data[,<span class="dv">3</span><span class="sc">:</span><span class="dv">12</span>] <span class="ot">&lt;-</span> <span class="fu">scale</span>(new_imputed_data[,<span class="dv">3</span><span class="sc">:</span><span class="dv">12</span>])</span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>new_scaled_data_ft <span class="ot">&lt;-</span> new_scaled_data <span class="sc">|&gt;</span> <span class="fu">slice</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(new_scaled_data)<span class="sc">-</span><span class="dv">1</span>)</span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a>new_training_rows <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(new_scaled_data_ft), </span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a>                        <span class="at">size =</span> <span class="fu">nrow</span>(new_scaled_data_ft)<span class="sc">/</span><span class="dv">2</span>)</span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a>new_train_data <span class="ot">&lt;-</span> new_scaled_data_ft[new_training_rows, ]</span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a>new_test_data <span class="ot">&lt;-</span> new_scaled_data_ft[(<span class="sc">-</span>new_training_rows), ]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This data has all of the same variables as before, but are now labeled as the data for the previous year (.PrevYear) and the market cap data for the year following it (.NextYear). All of the years are combined vertically, and the market cap information for the previous year is not included in the row.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>new_NN_model <span class="ot">&lt;-</span> <span class="fu">neuralnet</span>(MarketCap.NextYear <span class="sc">~</span> .,</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>                      <span class="at">data =</span> new_train_data[,<span class="dv">3</span><span class="sc">:</span><span class="dv">12</span>],</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>                      <span class="at">hidden =</span> <span class="fu">c</span>(<span class="dv">5</span>),</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>                      <span class="at">linear.output =</span> <span class="cn">TRUE</span>)</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>new_predictions_scaled <span class="ot">&lt;-</span> <span class="fu">predict</span>(new_NN_model, new_test_data[,<span class="dv">3</span><span class="sc">:</span><span class="dv">12</span>])</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>new_results_scaled <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">realMC =</span> (new_test_data<span class="sc">$</span>MarketCap.NextYear), </span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>                      <span class="at">predictedMC =</span> new_predictions_scaled) <span class="sc">|&gt;</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">difference =</span> <span class="fu">abs</span>(realMC <span class="sc">-</span> predictedMC))</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(new_results_scaled<span class="sc">$</span>difference)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.2925384</code></pre>
</div>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>new_predictions <span class="ot">&lt;-</span> <span class="fu">abs</span>(new_predictions_scaled <span class="sc">*</span> <span class="dv">134389188796</span> <span class="sc">+</span> <span class="dv">65833103905</span>)</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>new_results <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">realMC =</span> (new_test_data<span class="sc">$</span>MarketCap.NextYear<span class="sc">*</span> <span class="dv">134389188796</span> <span class="sc">+</span> <span class="dv">65833103905</span>), </span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>                      <span class="at">predictedMC =</span> new_predictions) <span class="sc">|&gt;</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">difference =</span> <span class="fu">abs</span>(realMC <span class="sc">-</span> predictedMC))</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(new_results<span class="sc">$</span>difference)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3.82e+10</code></pre>
</div>
</div>
<p>This model is much more applicable and related to how an investor would create a DCF. Now that we have this model and tested it, we would be able to actually apply it to data from this year (for example) and make predictions for future years.</p>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>In summary, algorithms such as neural networks and random forests can be a useful way to make predictions for market cap values, but should not be the <em>only</em> source of evaluation.</p>
<p>This method is much faster than direct calculations such as a DCF, but is unable to capture the true relationships between the variables the way that typical finance methods do.</p>
<p>These models are looking at trends across all data within the S&amp;P 500 company financial market, but real financial modeling methods mainly look at the data from the company they are trying to predict for (only looking at other comparing companies for additional insights such as growth rate trends).</p>
<p>When dealing with important investments, a careful analysis that is tailored to that specific company and involves the “human” aspect of the investors assumptions is the best option. However, these models, especially a well-trained and detailed deep learning model can be a great addition to an investor’s toolkit and variable importance analysis can also help get a better understanding of what needs to be examined in further detail.</p>
</section>
<section id="notes" class="level2">
<h2 class="anchored" data-anchor-id="notes">Notes</h2>
<ul>
<li><p>Further topics/data sets that could be interesting to analyze:</p>
<ul>
<li><p>Use a data set that includes all of the balance sheet, income statement, and cash flow statement information as variables.</p></li>
<li><p>If we used a data set that had the information needed to do a DCF and <em>only</em> that information (i.e.&nbsp;future cash flows, weighted average cost of capital, growth rates, revenues, operating expenditures, etc.), would our model be able to pick up on the relationship between these variables and the equity value in the same way that a DCF uses their relationship?</p></li>
</ul></li>
<li><p>We are using a linear model/relationship for our neural network, so we are not discussing activation functions and their importance for allowing neural networks to find complex relationships (such as image recognition).</p></li>
</ul>
</section>
<section id="references" class="level2">
<h2 class="anchored" data-anchor-id="references">References</h2>
<p><a href="https://www.calcbench.com/home/aboutus">Calcbench Website (homepage)</a></p>
<p><a href="https://cran.r-project.org/web/packages/neuralnet/neuralnet.pdf"><code>neuralnet</code> Documentation</a></p>
<p><a href="https://www.datacamp.com/tutorial/neural-network-models-r?utm_source=google&amp;utm_medium=paid_search&amp;utm_campaignid=19589720830&amp;utm_adgroupid=157156377351&amp;utm_device=c&amp;utm_keyword=&amp;utm_matchtype=&amp;utm_network=g&amp;utm_adpostion=&amp;utm_creative=720362650741&amp;utm_targetid=aud-2191467490030:dsa-2218886984060&amp;utm_loc_interest_ms=&amp;utm_loc_physical_ms=9032092&amp;utm_content=&amp;utm_campaign=230119_1-sea~dsa~tofu_2-b2c_3-us_4-prc_5-na_6-na_7-le_8-pdsh-go_9-nb-e_10-na_11-na-bfcm24&amp;gad_source=1&amp;gclid=CjwKCAiA3ZC6BhBaEiwAeqfvynBfKnxU17FuXukMsB2KwDZAGC6W4peqslfua8agY1crLfCI-7hW8hoCDA0QAvD_BwE">Data Camp Neural Network Article</a></p>
<p><a href="https://rdrr.io/cran/NeuralNetTools/man/plotnet.html"><code>NeuralNetTools</code> Documentation</a></p>
<p><a href="https://www.statology.org/r-unscale/">Scaling and Unscaling</a></p>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>